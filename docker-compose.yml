version: '3'
services:
  mongo:
    image: mongo:latest
    networks:
      - webnet
  redis:
    image: redis:latest
    networks:
      - webnet
  zookeeper:
    image: zookeeper:latest
    networks:
      - webnet
  proxy:
    image: proxy-v2ray:latest
    networks:
      - webnet
  makeflow-web-server:
    image: makeflow-web-e2e:latest
    networks:
      - webnet
    depends_on:
      - mongo
      - redis
      - zookeeper
      - proxy
    environment:
      - APPLICATION=main
      - ENVIRONMENT=e2e
      - COOKIE_SECRET_KEYS
      - OSS_KEY
      - OSS_SECRET
      - FIREBASE_SERVER_KEY
      - FCM_APPLICATION_PUBLIC_KEY
      - FCM_APPLICATION_PRIVATE_KEY
  makeflow-web-consumer:
    image: makeflow-web-e2e:latest
    networks:
      - webnet
    depends_on:
      - mongo
      - redis
      - zookeeper
      - proxy
    environment:
      - APPLICATION=consumer
      - ENVIRONMENT=e2e
      - COOKIE_SECRET_KEYS
      - OSS_KEY
      - OSS_SECRET
      - FIREBASE_SERVER_KEY
      - FCM_APPLICATION_PUBLIC_KEY
      - FCM_APPLICATION_PRIVATE_KEY
  test:
    build:
      context: .
      args:
        proxy: ${PROXY}
    networks:
      - webnet
    depends_on:
      - makeflow-web-server
      - makeflow-web-consumer
    environment:
      - ENVIRONMENT=e2e
      - CI
    command: yarn test:${TEST_PROJECT}
networks:
  webnet:
